target_default: 4_data_release

include:
  - 1_spatial.yml # 1_site_data.yml gets included via this file
  
packages:
  - yaml
  - xml2
  - whisker
  - rgdal
  - httr
  - sbtools
  - dplyr
  - rgeos
  - dataRetrieval
  - meddle
  
sources:
  - ../4_data_release/code/prepare_site_data.R
  - ../4_data_release/code/post_data_release.R
  - ../lib/load_profile.R
  
targets:
  4_data_release:
    depends: 
      - site_catchments
      - site_points
      - metadata_all
  
  # -- data munging for release --
  
  meta_all:
    command: combine_site_data(meta_basic, meta_dvqcoefs, outfile=target_name)
  
  # -- parent metadata --
  
  parent_metadata: 
    command: yaml.load_file('../4_data_release/in/metadata_parent.yaml')
    
  # -- intermediate tables --
  
  ../4_data_release/in/catchment_attr.csv:
    command: attribute_skeleton(spatial.catchments, target_name)
  
  ../4_data_release/in/points_attr.csv:
    command: attribute_skeleton(spatial.points, target_name)
  
  ../4_data_release/in/site_data_attr.csv:
    command: attribute_skeleton(meta_all, target_name)
    
  # -- autopopulate metadata -- 
  
  catchment_metadata:
    command: extract_feature(spatial.catchments)
  
  points_metadata:
    command: extract_feature(spatial.points)  
  
  # -- formulate manual entry and extracted metadata -- 
  
  catchment_attr:
    command: as.attr_list('../4_data_release/in/catchment_attr.csv')  
  
  points_attr:
    command: as.attr_list('../4_data_release/in/points_attr.csv')
  
  site_data_attr:
    command: as.attr_list('../4_data_release/in/site_data_attr.csv')
  
  # -- meta out --
  
  ../4_data_release/out/site_data.xml:
    command: render("../4_data_release/in/metadata_site_data.yaml", target_name, points_metadata, site_data_attr, parent_metadata)
  
  ../4_data_release/out/site_catchment_shapefile.shp.xml:
    command: render("../4_data_release/in/metadata_site_catchment.yaml", target_name, catchment_metadata, catchment_attr, parent_metadata)
  
  ../4_data_release/out/site_points_shapefile.shp.xml:
    command: render("../4_data_release/in/metadata_site_points.yaml", target_name, points_metadata, points_attr, parent_metadata)
    
  catchment_shapefile:
    command: write_shapefile(spatial.catchments, target_name)
    
  points_shapefile:
    command: write_shapefile(spatial.points, target_name)
  
  # -- SB posting --

  stream_metab_powell_release:
    command: create_release_parent(target_name, I('57adfa86e4b0fc09faad6d87'))

  pc1_spatial:
    command: create_release_child(stream_metab_powell_release, target_name)
    
  pc1_site_metadata:
    command: create_release_child(stream_metab_powell_release, target_name)
  
  # -- final targets --
  
  site_catchments:
    command: create_release_item(pc1_spatial, target_name, catchment_shapefile, '../4_data_release/out/site_catchment_shapefile.shp.xml')
    depends: spatial.catchments

  site_points:
    command: create_release_item(pc1_spatial, target_name, points_shapefile, '../4_data_release/out/site_points_shapefile.shp.xml')
    depends: spatial.points
  
  metadata_all:
    command: create_release_item(pc1_site_metadata, target_name, meta_all, '../4_data_release/out/site_data.xml')
