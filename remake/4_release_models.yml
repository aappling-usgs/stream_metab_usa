target_default: 4_release_models

include:
  - 4_release_timeseries.yml # 1_site_data.yml, 2_metab_models.yml, 2_metab_outputs.yml, and 4_release_parent.yml get included via this file
  
packages:
  - yaml
  - whisker
  - dplyr
  - meddle
  - mda.streams
  
sources:
  - ../4_data_release/code/post_data_release.R
  - ../4_data_release/code/model_release_tasks.R
  - ../lib/load_profile.R
  - ../lib/create_task_makefile.R
  - ../lib/check_frozen.R
  
targets:
  4_release_models:
    depends: 
      - post_config
      - ../4_data_release/log/4_tasks_model_info.ind
      - ../4_data_release/log/4_tasks_model_sites.ind
      - post_diagnostics
      - post_metabolism
  
  # -- SB posting: create the items to host data and metadata --

  pc1_model_config:
    command: create_release_child(stream_metab_powell_release, target_name)
  pc1_inputs:
    command: create_release_child(stream_metab_powell_release, target_name)
  pc1_model_fits:
    command: create_release_child(stream_metab_powell_release, target_name)
  pc1_diagnostics:
    command: create_release_child(stream_metab_powell_release, target_name)
  pc1_metabolism:
    command: create_release_child(stream_metab_powell_release, target_name)
  
  # -- munge & write & post data for release --
  
  model_release_folders:
    command: create_dirs(
      model=I('../4_data_release/cache/models/models'),
      prep=I('../4_data_release/cache/models/prep'),
      post=I('../4_data_release/cache/models/post'),
      log=I('../4_data_release/log/models'))
      
  # model_config: post the file
  
  post_config:
    command: append_release_files(
      sb.id=pc1_model_config,
      files='../2_metab_models/run3/out/config.tsv')
  
  # model_info: extract inputs, outputs, diagnostics from each model.
  # no posting yet
  
  model_info_plan:
    command: create_model_info_task_plan(metab.config, folders=model_release_folders)
  
  4_tasks_model_info.yml:
    command: create_model_info_makefile(
      makefile=target_name, task_plan=model_info_plan,
      template_file='../lib/task_makefile.mustache')

  ../4_data_release/log/4_tasks_model_info.ind:
    command: loop_model_tasks(
      job_target=I('4_tasks_model_info'), 
      task_plan=model_info_plan, 
      task_makefile='4_tasks_model_info.yml')
      
  # model_sites: combine model info into site-level info,
  # post inputs and fits to site-level SB items

  model_sites_plan:
    command: create_model_sites_task_plan(
      metab.config, folders=model_release_folders,
      inputs_item=I('pc1_inputs'), fits_item=I('pc1_model_fits')) # quote the targets so the task file can refer to them symbolically
    
  4_tasks_model_sites.yml:
    command: create_model_sites_makefile(
      makefile=target_name, task_plan=model_sites_plan,
      template_file='../lib/task_makefile.mustache')

  ../4_data_release/log/4_tasks_model_sites.ind:
    depends: ../4_data_release/log/4_tasks_model_info.ind
    command: loop_model_tasks(
      job_target=I('4_tasks_model_sites'), 
      task_plan=model_sites_plan, 
      task_makefile='4_tasks_model_sites.yml')
  
  # model diagnostics: combine diagnostics for each file into single table,
  # add columns for final model-level and site-level assessments

  ../4_data_release/cache/models/post/diagnostics.zip:
    depends: ../4_data_release/log/4_tasks_model_info.ind
    command: combine_model_diagnostics(target_name, model_info_plan)

  post_diagnostics:
    command: append_release_files(
      sb.id=pc1_diagnostics,
      files='../4_data_release/cache/models/post/diagnostics.zip')

  # daily metabolism: combine model info and timeseries info into single
  # highly useful data.frame of many predictions & predictors, all sites.
  # post it.
  
  ../4_data_release/cache/models/post/daily_predictions.zip:
    depends: ../4_data_release/log/4_tasks_model_info.ind
    command: combine_model_dailies(target_name, model_info_plan,
      '../4_data_release/cache/models/daily_predictors.rds')

  post_metabolism:
    command: append_release_files(
      sb.id=pc1_metabolism,
      files='../4_data_release/cache/models/post/daily_predictions.zip')

    
  # -- read manual entry and extracted metadata -- 
  
  #site_data_attr:
  #  command: as.attr_list('../4_data_release/in/site_data_attr.csv')
  
  # -- create final metadata files --
  
  #../4_data_release/out/site_data.xml:
  #  command: render("../4_data_release/in/metadata_site_data.yaml", target_name, points_meta, site_data_attr, parent_metadata)

  # -- final targets: post data and metadata to SB --
  
  #release_site_data:
  #  command: create_release_item(pc1_site_metadata, target_name, '../4_data_release/cache/site_data.tsv', '../4_data_release/out/site_data.xml')
